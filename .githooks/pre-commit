#!/usr/bin/env bash
# .githooks/pre-commit
# Pre-commit hook to ensure code formatting

set -e

# Check if we're in the right directory
if [ ! -f "MSP430.Emulator.sln" ]; then
    echo "Error: pre-commit hook must be run from repository root"
    exit 1
fi

echo "==> Running pre-commit formatting check..."

# Check if we have staged files that need formatting
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cs|csproj|sln)$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo "✅ No C# files staged, skipping formatting check"
    exit 0
fi

echo "Checking formatting for staged files:"
echo "$STAGED_FILES" | sed 's/^/  - /'

# Run formatter in verification mode first
if ./script/lint 2>/dev/null; then
    echo "✅ Code formatting check passed"
    exit 0
fi

# If verification fails, run full formatter
echo "⚠️  Formatting issues detected, running formatter..."
./script/format

# Check if any files were modified by the formatter
if ! git diff --quiet; then
    echo ""
    echo "⚠️  Code formatting changes were applied!"
    echo "    Please review the changes and commit them:"
    echo ""
    git diff --name-only | sed 's/^/      /'
    echo ""
    echo "    Run the following commands to include formatting changes:"
    echo "      git add ."
    echo "      git commit --amend --no-edit"
    echo ""
    exit 1
fi

echo "✅ Code formatting check passed"