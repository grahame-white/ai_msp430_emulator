name: GitHub Issues Automation

on:
  push:
    branches: [ main, develop ]
    paths: 
      - 'MSP430_EMULATOR_TASKS.md'
      - '.github/scripts/**'
      - '.github/config/issue-templates.json'
  
  pull_request:
    branches: [ main ]
    paths:
      - 'MSP430_EMULATOR_TASKS.md'
      - '.github/scripts/**'
      - '.github/config/issue-templates.json'
  
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (preview only)'
        required: false
        default: 'true'
        type: boolean
      force_recovery:
        description: 'Force disaster recovery mode'
        required: false
        default: 'false'
        type: boolean
      protect_manual:
        description: 'Scan and protect manual issues'
        required: false
        default: 'true'
        type: boolean

jobs:
  validate-tasks:
    name: Validate Task List
    runs-on: ubuntu-latest
    outputs:
      tasks-valid: ${{ steps.validate.outputs.valid }}
      tasks-count: ${{ steps.validate.outputs.count }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: '.github/scripts/package*.json'

    - name: Install dependencies
      run: |
        cd .github/scripts
        if [ ! -f package.json ]; then
          npm init -y
          npm install @octokit/rest
        else
          npm install
        fi

    - name: Validate task parsing
      id: validate
      run: |
        cd .github/scripts
        node parse-tasks.js ../../../MSP430_EMULATOR_TASKS.md > /tmp/tasks.json
        
        # Check if parsing was successful
        if [ $? -eq 0 ]; then
          echo "valid=true" >> $GITHUB_OUTPUT
          TASK_COUNT=$(jq '.totalTasks' /tmp/tasks.json)
          echo "count=$TASK_COUNT" >> $GITHUB_OUTPUT
          echo "âœ… Successfully parsed $TASK_COUNT tasks"
        else
          echo "valid=false" >> $GITHUB_OUTPUT
          echo "count=0" >> $GITHUB_OUTPUT
          echo "âŒ Task parsing failed"
          exit 1
        fi

    - name: Upload parsed tasks
      uses: actions/upload-artifact@v4
      with:
        name: parsed-tasks
        path: /tmp/tasks.json
        retention-days: 7

  dry-run-preview:
    name: Generate Preview
    runs-on: ubuntu-latest
    needs: validate-tasks
    if: needs.validate-tasks.outputs.tasks-valid == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: |
        cd .github/scripts
        npm init -y
        npm install @octokit/rest

    - name: Generate dry run preview
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd .github/scripts
        echo "ðŸ” Generating preview of changes..."
        node dry-run.js ../../../MSP430_EMULATOR_TASKS.md > /tmp/preview.txt
        
        echo "## ðŸ“‹ Issue Automation Preview" >> $GITHUB_STEP_SUMMARY
        echo "Found **${{ needs.validate-tasks.outputs.tasks-count }}** tasks to process" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Preview Details" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat /tmp/preview.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Upload preview
      uses: actions/upload-artifact@v4
      with:
        name: automation-preview
        path: /tmp/preview.txt
        retention-days: 30

  protect-manual-issues:
    name: Protect Manual Issues
    runs-on: ubuntu-latest
    needs: validate-tasks
    if: |
      needs.validate-tasks.outputs.tasks-valid == 'true' && 
      (github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main') &&
      (github.event.inputs.protect_manual != 'false')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: |
        cd .github/scripts
        npm init -y
        npm install @octokit/rest

    - name: Protect manual issues
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd .github/scripts
        DRY_RUN_FLAG=""
        if [ "${{ github.event.inputs.dry_run }}" = "true" ] || [ "${{ github.event_name }}" = "pull_request" ]; then
          DRY_RUN_FLAG="--dry-run"
        fi
        
        echo "ðŸ›¡ï¸ Scanning for manual issues to protect..."
        node manual-issue-protector.js $DRY_RUN_FLAG

  synchronize-issues:
    name: Synchronize Issues
    runs-on: ubuntu-latest
    needs: [validate-tasks, protect-manual-issues]
    if: |
      always() && 
      needs.validate-tasks.outputs.tasks-valid == 'true' &&
      (needs.protect-manual-issues.result == 'success' || needs.protect-manual-issues.result == 'skipped')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: |
        cd .github/scripts
        npm init -y
        npm install @octokit/rest

    - name: Determine operation mode
      id: mode
      run: |
        if [ "${{ github.event.inputs.force_recovery }}" = "true" ]; then
          echo "mode=recovery" >> $GITHUB_OUTPUT
          echo "ðŸš¨ Disaster recovery mode enabled"
        elif [ "${{ github.event.inputs.dry_run }}" = "true" ] || [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "mode=dry-run" >> $GITHUB_OUTPUT
          echo "ðŸ” Dry run mode enabled"
        else
          echo "mode=sync" >> $GITHUB_OUTPUT
          echo "ðŸ”„ Full synchronization mode enabled"
        fi

    - name: Run disaster recovery
      if: steps.mode.outputs.mode == 'recovery'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd .github/scripts
        echo "ðŸš¨ Running disaster recovery..."
        node disaster-recovery.js ../../../MSP430_EMULATOR_TASKS.md --force

    - name: Run synchronization
      if: steps.mode.outputs.mode == 'sync'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd .github/scripts
        echo "ðŸ”„ Running full synchronization..."
        node sync-tasks.js ../../../MSP430_EMULATOR_TASKS.md

    - name: Run dry run
      if: steps.mode.outputs.mode == 'dry-run'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd .github/scripts
        echo "ðŸ” Running dry run synchronization..."
        node sync-tasks.js ../../../MSP430_EMULATOR_TASKS.md --dry-run

    - name: Generate summary report
      if: always()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd .github/scripts
        echo "ðŸ“Š Generating summary report..."
        
        echo "## ðŸ”„ Issue Synchronization Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Mode:** ${{ steps.mode.outputs.mode }}" >> $GITHUB_STEP_SUMMARY
        echo "**Tasks Processed:** ${{ needs.validate-tasks.outputs.tasks-count }}" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.mode.outputs.mode }}" != "dry-run" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Synchronization Complete" >> $GITHUB_STEP_SUMMARY
          echo "Issues have been synchronized with the task list." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ [View Issues](https://github.com/${{ github.repository }}/issues?q=is%3Aissue+label%3Atask)" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Dry Run Complete" >> $GITHUB_STEP_SUMMARY
          echo "No changes were made. Check the preview above for planned changes." >> $GITHUB_STEP_SUMMARY
        fi

  notify-completion:
    name: Notify Completion
    runs-on: ubuntu-latest
    needs: [validate-tasks, synchronize-issues]
    if: |
      always() && 
      github.event_name != 'pull_request' &&
      (needs.synchronize-issues.result == 'success' || needs.synchronize-issues.result == 'failure')
    
    steps:
    - name: Create completion issue comment
      if: needs.synchronize-issues.result == 'success'
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          
          // Find recent issues automation-related issues to comment on
          const { data: issues } = await github.rest.search.issuesAndPullRequests({
            q: `repo:${owner}/${repo} is:issue label:task is:open`,
            sort: 'updated',
            order: 'desc',
            per_page: 1
          });
          
          if (issues.items.length > 0) {
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issues.items[0].number,
              body: `ðŸ¤– **Issues Automation Update**\n\nThe task list has been synchronized with GitHub issues.\n\n**Summary:**\n- Tasks processed: ${{ needs.validate-tasks.outputs.tasks-count }}\n- Workflow: [View run](https://github.com/${owner}/${repo}/actions/runs/${{ github.run_id }})\n- Trigger: ${context.eventName}\n\n*Automated by GitHub Issues Automation*`
            });
          }

    - name: Create error notification
      if: needs.synchronize-issues.result == 'failure'
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          
          await github.rest.issues.create({
            owner,
            repo,
            title: 'ðŸš¨ Issues Automation Error',
            body: `**Error in GitHub Issues Automation**\n\nThe automation workflow failed during execution.\n\n**Details:**\n- Run ID: ${{ github.run_id }}\n- Trigger: ${context.eventName}\n- Tasks to process: ${{ needs.validate-tasks.outputs.tasks-count }}\n\n**Action Required:**\n1. Check the [workflow logs](https://github.com/${owner}/${repo}/actions/runs/${{ github.run_id }})\n2. Review any parsing or API errors\n3. Consider running disaster recovery if issues are corrupted\n\n*Automatically created by GitHub Issues Automation*`,
            labels: ['bug', 'automation', 'high-priority']
          });

# Security and rate limiting
concurrency:
  group: issue-automation-${{ github.ref }}
  cancel-in-progress: false

# Permissions needed for the workflow
permissions:
  contents: read
  issues: write
  pull-requests: read