# 1.4 Operating Modes

The MSP430 family is designed for low-power applications and uses the different operating modes shown in
[Figure 1-5](#figure-1-5).

The operating modes take into account three different needs:

- Low power
- Speed and data throughput
- Minimizing current consumption of individual peripherals

Low-power modes LPM0 through LPM4 are configured with the `CPUOFF`, `OSCOFF`, `SCG0`, and `SCG1` bits in the `SR`.
The advantage of including the `CPUOFF`, `OSCOFF`, `SCG0`, and `SCG1` mode-control bits in the `SR` is that the present
operating mode is saved onto the stack during an interrupt service routine. Program flow returns to the previous
operating mode if the saved `SR` value is not altered during the interrupt service routine.
Program flow can be returned to a different operating mode by manipulating the saved `SR` value on the stack inside of
the interrupt service routine.
When setting any of the mode-control bits, the selected operating mode takes effect immediately.
Peripherals operating with any disabled clock are disabled until the clock becomes active. Peripherals may also be
disabled with their individual control register settings.
All I/O port pins, RAM, and registers are unchanged. Wake-up from LPM0 through LPM4 is possible through all enabled
interrupts.

When LPMx.5 (LPM3.5 or LPM4.5) is entered, the voltage regulator of the Power Management Module (PMM) is disabled. All
RAM and register contents are lost.
Although the I/O register contents are lost, the I/O pin states are locked upon LPMx.5 entry. See the
[Digital I/O chapter]() for further details.
Wake-up from LPM4.5 is possible from a power sequence, a R̅S̅T̅ event, or from specific I/O.
Wake-up from LPM3.5 is possible from a power sequence, a R̅S̅T̅ event, an RTC event, an LF crystal fault, or from
specific I/O.

> [!NOTE]
> The TEST/SBWTCK pin is used for interfacing to the development tools through Spy-Bi-Wire.
> When the TEST/SBWTCK pin is high, wake-up times from LPM2 (device specific), LPM3, and LPM4 may be different compared
> to when TEST/SBWTCK is low.
> Pay careful attention to the real-time behavior when exiting from LPM2 (device specific), LPM3, and LPM4 with the
> device connected to a development tool (for example, MSP-FET430UIF). See the [PMM chapter]() for details.

<a id="figure-1-5"></a>

![Figure 1-5. Operation Modes](/images/fr4xx_fr2xx_family_user_guide/figure_1-5.jpg)

**Figure 1-5. Operation Modes**

<a id="table-1-2"></a>

| `SCG1`(1) | `SCG0` | `OSCOFF`(1) | `CPUOFF`(1) | Mode                         | CPU and Clocks Status(2)                                                                                                                                                                                                                                                                                    |
| --------- | ------ | ----------- | ----------- | ---------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 0         | 0      | 0           | 0           | Active                       | CPU, MCLK are active.<br>ACLK is active. SMCLK optionally active (SMCLKOFF = 0).<br>DCO is enabled if sources ACLK, MCLK, or SMCLK (SMCLKOFF = 0).<br>DCO bias is enabled if DCO is enabled or DCO sources MCLK or SMCLK<br>(SMCLKOFF = 0).<br>FLL is enabled if DCO is enabled.<br>CPU, MCLK are disabled. |
| 0         | 0      | 0           | 1           | LPM0                         | ACLK is active. SMCLK optionally active (SMCLKOFF = 0).<br>DCO is enabled if sources ACLK or SMCLK (SMCLKOFF = 0).<br>DCO bias is enabled if DCO is enabled or DCO sources MCLK or SMCLK<br>(SMCLKOFF = 0).<br>FLL is enabled if DCO is enabled.                                                            |
| 1         | 0      | 0           | 1           | LPM2<br>(device<br>specific) | CPU, MCLK, and FLL are disabled.<br>ACLK is active. SMCLK is disabled.<br>FLL is disabled.                                                                                                                                                                                                                  |
| 1         | 1      | 0           | 1           | LPM3                         | CPU, MCLK, and FLL are disabled.<br>ACLK is active. SMCLK is disabled.<br>FLL is disabled.                                                                                                                                                                                                                  |
| 1         | 1      | 1           | 1           | LPM4                         | CPU and all clocks are disabled.                                                                                                                                                                                                                                                                            |
| 1         | 1      | 1           | 1           | LPM3.5                       | When `PMMREGOFF` = 1, regulator is disabled. RAM retention in backup memory. In<br>this mode, RTC and LCD operation is possible when configured properly. See the RTC<br>and LCD modules for further details.                                                                                               |
| 1         | 1      | 1           | 1           | LPM4.5                       | When `PMMREGOFF` = 1, regulator is disabled. No memory retention. In this mode, all<br>clock sources are disabled; that is, no RTC operation is possible.                                                                                                                                                   |

(1) LPMx.5 modes are entered by following the correct entry sequence as defined in
[Section 1.4.2](#142-entering-and-exiting-low-power-modes-lpm0-through-lpm4).

(2) The system clocks and the low-power modes can be affected by the clock request system. See the
[clock system chapter]() for details.

**Table 1-2. Operation Modes**

## 1.4.1 Low-Power Modes and Clock Requests

A peripheral module request its clock sources automatically from the clock system (CS) module if it is required for its
proper operation, regardless of the current power mode of operation. For details, see [Section 3.2.12]().

Because of the clock request mechanism the system might not reach the low-power modes requested by the bits set in the
CPU status register, `SR`, as listed in [Table 1-3](#table-1-3).

<a id="table-1-3"></a>

| Requested (`SR` Bits<br>According to [Table 1-2](#table-1-2)) | Actual LPM<br>If No Clock Requested | Actual LPM<br>If Only ACLK Requested | Actual LPM<br>If SMCLK Requested |
| ------------------------------------------------------------- | ----------------------------------- | ------------------------------------ | -------------------------------- |
| LPM0                                                          | LPM0                                | LPM0                                 | LPM0                             |
| LPM2 (device specific)                                        | LPM2                                | LPM2                                 | LPM0                             |
| LPM3                                                          | LPM3                                | LPM3                                 | LPM0                             |
| LPM4                                                          | LPM4                                | LPM3                                 | LPM0                             |

**Table 1-3. Requested vs Actual LPM**

## 1.4.2 Entering and Exiting Low-Power Modes LPM0 Through LPM4

An enabled interrupt event wakes the device from low-power operating modes LPM0 through LPM4. The program flow for
exiting LPM0 through LPM4 is:

- Enter interrupt service routine
  - The `PC` and `SR` are stored on the stack.
  - The `CPUOFF`, `SCG1`, and `OSCOFF` bits are automatically reset.
- Options for returning from the interrupt service routine
  - The original `SR` is popped from the stack, restoring the previous operating mode.
  - The `SR` bits stored on the stack can be modified within the interrupt service routine to return to a different
    operating mode when the `RETI` instruction is executed.

```asm
; Enter LPM0 Example
 BIS #GIE + CPUOFF, SR               ; Enter LPM0
; ...                                ; Program stops here
;
; Exit LPM0 Interrupt Service Routine
 BIC #CPUOFF, 0(SP)                  ; Exit LPM0 on RETI
 RETI
```

```asm
; Enter LPM3 Example
 BIS #GIE + CPUOFF + SCG1 + SCG0, SR ; Enter LPM3
; ...                                ; Program stops here
;
; Exit LPM3 Interrupt Service Routine
 BIC #CPUOFF + SCG1 + SCG0, 0(SP)    ; Exit LPM3 on RETI
 RETI
```

```asm
; Enter LPM4 Example
 BIS #GIE + CPUOFF + OSCOFF + SCG1 + SCG0, SR ; Enter LPM4
; ...                                         ; Program stops here
;
; Exit LPM4 Interrupt Service Routine
 BIC #CPUOFF + OSCOFF + SCG1 + SCG0, 0(SP)    ; Exit LPM4 on RETI
 RETI
```

## 1.4.3 Low-Power Modes LPM3.5 and LPM4.5 (LPMx.5)

The low-power modes LPM3.5 and LPM4.5 (LPMx.5 (1)) give the lowest power consumption on a device. In LPMx.5, the core
LDO of the device is switched off. This has the following effects:

- Most of the modules are powered down.
  – In LPM3.5, only modules powered by the RTC LDO continue to operate. At least an RTC module is connected to the RTC
  LDO. See the device data sheet for other modules (if any) that are connected to the RTC LDO.
  – In LPM4.5 the RTC LDO and the connected modules are switched off.
- The register content of all modules and the CPU is lost.
- The SRAM content is lost.
- A wake-up from LPMx.5 causes a complete reset of the core.
- The application must initialize the complete device after a wakeup from LPMx.5.

The wake-up time from LPMx.5 is much longer than the wake-up time from any other power mode (see the device-specific
data sheet). This is because the core domain must power up and the device internal initialization must be done. In
addition, the application must be initialized again. Therefore, use LPMx.5 only when the application is in LPMx.5 for a
long time. Compute Through Power Loss (CTPL) is a utility API set that leverages FRAM to enable ease of use with LPMx.5
low-power modes and to provide a powerful shutdown mode that allows an application to save and restore critical system
components when a power loss is detected. Visit FRAM embedded software utilities for MSP ultra-low-power
microcontrollers for details.

(1) The abbreviation "LPMx.5" is used in this document to indicate both LPM3.5 and LPM4.5.

### 1.4.3.1 Enter LPMx.5

Follow these steps to enter LPMx.5:

1. Store any information that must be available after wakeup from LPMx.5 in FRAM.
1. For LPM4.5 set all ports to general-purpose I/Os (`PxSEL0` = 00h and `PxSEL1` = 00h).<br>
   For LPM3.5 if the LF crystal oscillator is used do not change the settings for the I/Os shared with the
   LF-crystal-oscillator. These pins must be configured as `LFXIN` and `LFXOUT`. Set all other port pins to
   general-purpose I/Os with `PxSEL0` and `PxSEL1` bits equal to 0.
1. Set the port pin direction and output bits as necessary for the application.
1. To enable a wakeup from an I/O do the following:
   1. Select the wakeup edge (`PxIES`)
   1. Clear the interrupt flag (`PxIFG`)
   1. Set the interrupt enable bit (`PxIE`)
1. For LPM3.5, the modules that stay active must be enabled. For example, the RTC must be enabled if necessary. Only
   modules connected to the RTC LDO can stay active.
1. For LPM3.5, enable any interrupt sources from these modules as wakeup sources, if necessary. See the corresponding
   module chapter.
1. Disable the watchdog timer WDT if it is enabled and in watchdog mode. If the WDT is enabled and in watchdog mode,
   the device does not enter LPMx.5.
1. Clear the `GIE` bit:<br>
   `BIC #GIE, SR`
1. Do the following steps to set the `PMMREGOFF` bit in the `PMMCTL0` register:
   1. Write the correct PMM password to get write access to the PMM control registers.<br>
      `MOV.B #PMMPW_H, &PMMCTL0_H`
   1. Set PMMREGOFF bit in the PMMCTL0 register.<br>
      `BIS.B #PMMREGOFF, &PMMCTL0_L`
   1. To disable the SVS during LPMx.5, clear the SVSHE bit in PMMCTL0.<br>
      `BIC.B #SVSHE, &PMMCTL0_L`
   1. Write an incorrect PMM password to disable the write access to the PMM control registers.
      `MOV.B #000h, &PMMCTL0_H`
1. Enter LPMx.5 with the following instruction:<br>
   `BIS #CPUOFF + OSCOFF + SCG0 + SCG1, SR`

The device enters LPM3.5 if any module that is connected to the RTC LDO is enabled. The device enters LPM4.5 if none of
the modules that are connected to the RTC LDO are enabled.

### 1.4.3.2 Exit From LPMx.5

The following conditions cause an exit from LPMx.5:

- A wake-up event on an I/O, if configured and enabled. The interrupt flag of the corresponding port pin is set
  (`PxIFG`). The `PMMLPM5IFG` bit is set.
- A wake-up event from the RTC, if enabled. The corresponding interrupt flag in the RTC is set. The `PMMLPM5IFG` bit is
  set.
- A wake-up signal from the R̅S̅T̅ pin.
- A power cycle. Either the `SVSHIFG` or none of the `PMMIFG`s is set.

Any exit from LPMx.5 causes a BOR. The program execution starts at the address the reset vector points to.
`PMMLPM5IFG` = 1 indicates a wakeup from LPMx.5 or the System Reset Vector Word register `SYSRSTIV` can be used to
decode the reset condition (see the device-specific data sheet). After wakeup from LPMx.5, the state of the I/Os and
the modules connected to the RTC LDO are locked and remain unchanged until you clear the `LOCKLPM5` bit in the
`PM5CTL0` register.

### 1.4.3.3 Wake up from LPM3.5

Do the following steps after a wakeup from LPM3.5:

1. Initialize the registers of the modules connected to the RTC LDO exactly the same way as they were configured before
   the device entered LPM3.5 but do not enable the interrupts.
1. Initialize the port registers exactly the same way as they were configured before the device entered LPM3.5 but do
   not enable port interrupts.
1. If the LF-crystal-oscillator was used in LPM3.5 the corresponding I/Os must be configured as `LFXIN` and `LFXOUT`.
   The LF-crystal-oscillator must be enabled in the clock system (see the [clock system chapter]()).
1. Clear the `LOCKLPM5` bit in the `PM5CTL0` register.
1. Enable port interrupts as necessary.
1. Enable module interrupts.
1. After enabling the port and module interrupts, the wake-up interrupt is serviced as a normal interrupt.

### 1.4.3.4 Wake up from LPM4.5

Do the following steps after a wakeup from LPM4.5:

1. Initialize the port registers exactly the same way as they were configured before the device entered LPM4.5 but do
   not enable port interrupts.
2. Clear the `LOCKLPM5` bit in the `PM5CTL0` register.
3. Enable port interrupts as necessary.
4. After enabling the port interrupts, the wake-up interrupt is serviced as a normal interrupt.

If a crystal oscillator is needed after a wakeup from LPM4.5 then configure the corresponding pins and start the
oscillator after you cleared the `LOCKLPM5` bit.

## 1.4.4 Extended Time in Low-Power Modes

The temperature coefficient of the DCO should be considered when the DCO is disabled for extended low power mode
periods. If the temperature changes significantly, the DCO frequency at wakeup may be significantly different from when
the low-power mode was entered and may be out of the specified range. To avoid this, the DCO output can be divided by
two before entering the low-power mode for extended periods of time where temperature can change.

```asm
; Enter LPM3 Example with DCO/2 settings (to be updated upon the completion of CS module)
 MOV #FLLD0 + FLLN                            ; Set DCO Output divided by 2
 BIS #GIE + CPUOFF + OSCOFF + SCG1 + SCG0, SR ; Enter LPM3
; ...                                         ; Program stops
;
; Interrupt Service Routine
 BIC #CPUOFF + OSCOFF + SCG1 + SCG0, 0(SR)    ; Exit LPM3 on RETI
 RETI
```
