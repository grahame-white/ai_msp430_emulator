#!/usr/bin/env bash
# script/check-automation-scripts
# Validate automation scripts for common issues that could cause CI failures
# This script is designed to be run locally before committing changes

set -euo pipefail

cd "$(dirname "$0")/.."

echo "ğŸ” Checking automation scripts for common CI failure causes..."

# Check 1: Validate package-lock.json synchronization
echo "Checking package-lock.json synchronization..."
cd .github/scripts

if ! npm ci --dry-run > /dev/null 2>&1; then
    echo "âŒ package-lock.json is out of sync with package.json"
    echo "   Run 'npm install' in .github/scripts and commit the updated package-lock.json"
    exit 1
fi
echo "âœ… Dependencies are synchronized"

# Check 2: Validate that all scripts have proper error handling
echo "Checking for proper error handling..."
if ! grep -q "set -e" lint-with-annotations.sh; then
    echo "âŒ lint-with-annotations.sh should use 'set -e' for proper error handling"
    exit 1
fi
echo "âœ… Error handling is proper"

# Check 3: Validate that required Node.js modules are available
echo "Checking Node.js dependencies..."
if ! node -e "require('eslint')" 2>/dev/null; then
    echo "âŒ ESLint is not properly installed"
    exit 1
fi

if ! node -e "require('prettier')" 2>/dev/null; then
    echo "âŒ Prettier is not properly installed"
    exit 1
fi

if ! command -v jq >/dev/null 2>&1; then
    echo "âŒ jq is not available (required for JSON processing)"
    exit 1
fi
echo "âœ… All required dependencies are available"

# Check 4: Run the actual automation script tests
echo "Running automation script tests..."
if ! npm test > /dev/null 2>&1; then
    echo "âŒ Automation script tests failed"
    echo "   Run 'cd .github/scripts && npm test' for details"
    exit 1
fi
echo "âœ… Automation script tests passed"

# Check 5: Test the lint-with-annotations.sh script
echo "Testing lint-with-annotations.sh..."
if ! ./lint-with-annotations.sh > /dev/null 2>&1; then
    echo "âŒ lint-with-annotations.sh failed"
    echo "   Run 'cd .github/scripts && ./lint-with-annotations.sh' for details"
    exit 1
fi
echo "âœ… lint-with-annotations.sh executed successfully"

cd ../..

# Check 6: Validate annotation tests
echo "Running annotation tests..."
if ! ./script/test-annotations > /dev/null 2>&1; then
    echo "âŒ Annotation tests failed"
    echo "   Run './script/test-annotations' for details"
    exit 1
fi
echo "âœ… Annotation tests passed"

echo ""
echo "ğŸ‰ All automation script checks passed!"
echo "   Your changes are ready for CI"