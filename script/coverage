#!/usr/bin/env bash
# script/coverage
# Generate and validate test coverage reports

set -e

cd "$(dirname "$0")/.."

echo "==> Generating MSP430 Emulator test coverage..."

# Ensure we have a clean test environment
rm -rf TestResults

# Run tests with coverage collection
echo "==> Running unit tests with coverage..."
dotnet test tests/MSP430.Emulator.Tests/MSP430.Emulator.Tests.csproj \
  --configuration Release \
  --no-build \
  --verbosity normal \
  --collect:"XPlat Code Coverage" \
  --results-directory TestResults/Unit

echo "==> Running integration tests with coverage..."
dotnet test tests/MSP430.Emulator.IntegrationTests/MSP430.Emulator.IntegrationTests.csproj \
  --configuration Release \
  --no-build \
  --verbosity normal \
  --collect:"XPlat Code Coverage" \
  --results-directory TestResults/Integration

# Check if we have coverage files
if ! find TestResults -name "coverage.cobertura.xml" | grep -q .; then
  echo "⚠️  No coverage files found. Coverage reporting may not be available."
  exit 0
fi

# Install coverage reporting tool if not available
if ! command -v reportgenerator >/dev/null 2>&1; then
  echo "==> Installing coverage report generator..."
  dotnet tool install -g dotnet-reportgenerator-globaltool
fi

# Generate consolidated coverage report
echo "==> Generating coverage report..."
reportgenerator \
  -reports:"TestResults/**/coverage.cobertura.xml" \
  -targetdir:"TestResults/CoverageReport" \
  -reporttypes:"HtmlInline_AzurePipelines;Cobertura;JsonSummary"

# Check coverage thresholds
if [ -f "TestResults/CoverageReport/Summary.json" ]; then
  LINE_COVERAGE=$(grep -o '"linecoverage": [0-9.]*' TestResults/CoverageReport/Summary.json | head -1 | grep -o '[0-9.]*' || echo "0")
  BRANCH_COVERAGE=$(grep -o '"branchcoverage": [0-9.]*' TestResults/CoverageReport/Summary.json | head -1 | grep -o '[0-9.]*' || echo "0")
  
  if [ -n "$LINE_COVERAGE" ] && [ "$LINE_COVERAGE" != "null" ] && [ "$LINE_COVERAGE" != "0" ]; then
    echo "==> Line coverage: $LINE_COVERAGE%"
    
    # Check line coverage against threshold (default 80%)
    LINE_THRESHOLD=${COVERAGE_THRESHOLD:-80}
    LINE_PASS=true
    if (( $(echo "$LINE_COVERAGE < $LINE_THRESHOLD" | bc -l 2>/dev/null || echo "0") )); then
      echo "❌ Line coverage $LINE_COVERAGE% is below minimum threshold of $LINE_THRESHOLD%"
      LINE_PASS=false
    else
      echo "✅ Line coverage $LINE_COVERAGE% meets minimum threshold of $LINE_THRESHOLD%"
    fi
  else
    echo "⚠️  No line coverage data available in summary."
    LINE_PASS=false
  fi
  
  if [ -n "$BRANCH_COVERAGE" ] && [ "$BRANCH_COVERAGE" != "null" ] && [ "$BRANCH_COVERAGE" != "0" ]; then
    echo "==> Branch coverage: $BRANCH_COVERAGE%"
    
    # Check branch coverage against threshold (default 70%)
    BRANCH_THRESHOLD=${BRANCH_COVERAGE_THRESHOLD:-70}
    BRANCH_PASS=true
    if (( $(echo "$BRANCH_COVERAGE < $BRANCH_THRESHOLD" | bc -l 2>/dev/null || echo "0") )); then
      echo "❌ Branch coverage $BRANCH_COVERAGE% is below minimum threshold of $BRANCH_THRESHOLD%"
      BRANCH_PASS=false
    else
      echo "✅ Branch coverage $BRANCH_COVERAGE% meets minimum threshold of $BRANCH_THRESHOLD%"
    fi
  else
    echo "⚠️  No branch coverage data available in summary."
    BRANCH_PASS=false
  fi
  
  # Both line and branch coverage must pass
  if [ "$LINE_PASS" = false ] || [ "$BRANCH_PASS" = false ]; then
    echo "❌ Coverage validation failed - both line and branch coverage thresholds must be met"
    exit 1
  fi
else
  echo "⚠️  No coverage summary found."
  exit 1
fi

echo "==> Coverage analysis completed successfully!"
echo "    Report available at: TestResults/CoverageReport/index.html"