#!/usr/bin/env bash
# script/lint
# Run code analysis and formatting checks
#
# Tools used:
# - dotnet format: C# code formatting verification
# - dotnet build: Static analysis via compiler warnings/errors
# - markdownlint-cli2: Markdown linting for documentation

set -e

cd "$(dirname "$0")/.."

echo "==> Running MSP430 Emulator code analysis..."

# Format code (check only, don't modify)
echo "==> Checking code formatting..."
dotnet format --verify-no-changes --verbosity diagnostic

# Run static analysis via build with warnings as errors
echo "==> Running static analysis..."
dotnet build --configuration Release --verbosity quiet

# Lint Markdown documentation
echo "==> Linting Markdown documentation..."
if command -v npm >/dev/null 2>&1 && [ -f "package.json" ]; then
    # Exclude SLAU445 reference documentation which contains very long lines from TI specifications
    npx markdownlint-cli2 "docs/**/*.md" "!docs/references/SLAU445/*.md" "*.md" || exit 1
else
    echo "Error: npm or package.json not found. Run './script/bootstrap' to install all required tools."
    exit 1
fi

echo "==> Code analysis completed successfully!"